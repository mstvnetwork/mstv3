<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Global Sync YouTube Player</title>
  <style>
    body {
      margin: 0;
      background: black;
      overflow: hidden;
    }
    #player-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    #banner {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #0066cc;
      color: white;
      font-weight: bold;
      font-size: 1em;
      white-space: nowrap;
      overflow: hidden;
    }
    #banner span {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 15s linear infinite;
    }
    @keyframes scroll {
      from { transform: translateX(0); }
      to { transform: translateX(-100%); }
    }
    #muteToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 24px;
      color: white;
      cursor: pointer;
      z-index: 10;
    }
    #spinner {
      position: absolute;
      width: 50px;
      height: 50px;
      border: 5px solid gold;
      border-top: 5px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="player-container">
    <div id="spinner"></div>
  </div>
  <div id="banner"><span>Loading...</span></div>
  <div id="muteToggle">ðŸ”‡</div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const ch = urlParams.get("ch") || "1";
    const jsonUrl = 'https://raw.githubusercontent.com/mstvnetwork/mstv3/main/sync-ch1.json';

    let videoList = [];
    let startTimeUtc;
    let currentSlot = -1;
    let muted = true;

    const banner = document.getElementById("banner").querySelector("span");
    const spinner = document.getElementById("spinner");
    const playerContainer = document.getElementById("player-container");
    const muteToggle = document.getElementById("muteToggle");

    muteToggle.onclick = () => {
      muted = !muted;
      updateMuteIcon();
      const iframe = document.querySelector("iframe");
      if (iframe) {
        const src = new URL(iframe.src);
        src.searchParams.set("mute", muted ? "1" : "0");
        iframe.src = src.toString();
      }
    };

    function updateMuteIcon() {
      muteToggle.textContent = muted ? "ðŸ”‡" : "ðŸ”Š";
    }

    function updateBanner(text) {
      banner.textContent = '';
      const span = document.createElement("span");
      span.textContent = text;
      banner.appendChild(span);
    }

    async function loadJson() {
      try {
        const response = await fetch(jsonUrl);
        const data = await response.json();
        videoList = data.video_list;
        startTimeUtc = new Date(data.start_time_utc).getTime();
        syncVideo();
        setInterval(syncVideo, 10000);
      } catch (e) {
        updateBanner("Failed to load JSON");
        console.error("Error loading JSON:", e);
      }
    }

    function syncVideo() {
      const now = Date.now();
      const offset = (now - startTimeUtc) / 1000;
      let accumulated = 0;
      for (let i = 0; i < videoList.length; i++) {
        const video = videoList[i];
        accumulated += video.duration_seconds;
        if (offset < accumulated) {
          const startOffset = Math.floor(offset - (accumulated - video.duration_seconds));
          if (currentSlot !== i) {
            currentSlot = i;
            playVideo(video.id, startOffset, video.title);
          }
          break;
        }
      }
    }

    function playVideo(videoId, startSeconds, title) {
      updateBanner(`Now Playing: ${title}`);
      const iframe = document.createElement("iframe");
      iframe.allow = "autoplay; encrypted-media";
      iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=${muted ? 1 : 0}&start=${startSeconds}&playsinline=1&enablejsapi=1&rel=0`;
      iframe.onload = () => spinner.style.display = "none";

      // Auto-skip if video fails to embed
      let loaded = false;
      const timeout = setTimeout(() => {
        if (!loaded) {
          console.warn("Video failed to load, skipping...");
          currentSlot++;
          syncVideo();
        }
      }, 10000); // 10 seconds

      iframe.onload = () => {
        loaded = true;
        spinner.style.display = "none";
      };

      playerContainer.innerHTML = "";
      playerContainer.appendChild(iframe);
      spinner.style.display = "block";
    }

    updateMuteIcon();
    loadJson();
  </script>
</body>
</html>
