<!DOCTYPE html>
<html>
<head>
    <title>My Custom YouTube Channel</title>
    <style>
        /* Basic styling for your page and player container */
        body { 
            font-family: sans-serif; 
            text-align: center; 
            margin-top: 50px; 
            background-color: #f0f0f0; 
            color: #333; 
        }
        h1 { 
            color: #333; 
        }
        
        /* Player container styling */
        .player-container {
            position: relative; /* Crucial for positioning child elements like logos/placeholders */
            width: 640px;      /* Set width */
            height: 390px;     /* Set height */
            margin: 20px auto; /* Center the player */
            background-color: #000; 
            border: 1px solid #ccc; 
            overflow: hidden; /* Important to clip anything outside the container */
        }

        /* YouTube player (iframe) styling */
        #player { 
            position: absolute; /* Takes full size of player-container */
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%; 
        }

        /* Unmute button styling */
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-size: 1em; 
        }
        button:hover { 
            background-color: #0056b3; 
        }

        /* Video title styling */
        #videoTitle { 
            font-size: 1.5em; 
            margin-bottom: 15px; 
            color: #555; 
        }

        /* Custom logo overlay styling */
        .custom-logo-overlay {
            position: absolute; 
            bottom: 10px;       
            right: 10px;        
            width: 80px;        
            height: auto;       
            z-index: 10;        /* Ensure it's above the player and placeholder */
            opacity: 0.9;       
        }

        /* Placeholder image styling */
        #endingPlaceholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures image covers the player area */
            z-index: 9;       /* Below the custom logo, above the player */
            display: none;    /* Hidden by default */
        }
    </style>
</head>
<body>
    <h1>My Custom YouTube Channel</h1>
    <div id="videoTitle"></div> <div class="player-container">
        <div id="player"></div> <img id="endingPlaceholder" src="https://raw.githubusercontent.com/mstvnetwork/mstv3/refs/heads/main/images%20(1).jpeg" alt="Coming Up Next" />
        
        <img src="/logo.png" alt="My Channel Logo" class="custom-logo-overlay" />
    </div>

    <button id="unmuteButton" onclick="unmuteVideo()">Unmute</button>

    <script>
        // --- STEP 1: REPLACE THIS URL WITH YOUR ACTUAL RENDER SERVER URL ---
        const renderServerUrl = "https://my-youtube-channel-server.onrender.com"; // <-- IMPORTANT: Change this line!
        // -----------------------------------------------------------------

        let player; // This will hold the YouTube player object
        let playlist = []; // This will store the playlist fetched from your Render server
        let currentVideoIndex = -1; // Keeps track of which video is currently playing
        let placeholderTimerId = null; // To manage the timeout for the placeholder image
        const SECONDS_BEFORE_END_TO_SHOW_PLACEHOLDER = 60; // How many seconds before the end to show the image

        // Get reference to the placeholder image
        const endingPlaceholder = document.getElementById('endingPlaceholder');

        // 1. Load the YouTube IFrame Player API code.
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api"; // Official YouTube API URL
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // 2. This function is called by the YouTube API once it's loaded.
        function onYouTubeIframeAPIReady() {
            console.log("YouTube IFrame API is ready.");
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: '', // Player starts empty, we'll load videos via JavaScript
                playerVars: {
                    'autoplay': 1,      // Attempt to autoplay
                    'controls': 0,      // Hide player controls
                    'mute': 1,          // Mute the video (highly recommended for autoplay to work)
                    'disablekb': 1,     // Disable keyboard controls (like spacebar to play/pause)
                    'fs': 0,            // Hide fullscreen button
                    'iv_load_policy': 3,// Hide annotations and cards
                    'modestbranding': 1, // Remove YouTube logo (some branding may remain)
                    'rel': 0            // Don't show related videos at the end
                },
                events: {
                    'onReady': onPlayerReady,           // When the player is ready
                    'onStateChange': onPlayerStateChange // When video starts, ends, pauses etc.
                }
            });
        }

        // 3. This function runs when the player is ready.
        async function onPlayerReady(event) {
            console.log("YouTube Player is ready!");
            await fetchAndPopulateVideos();

            if (playlist.length > 0) {
                currentVideoIndex = 0; // Start with the first video
                loadAndPlayVideo(playlist[currentVideoIndex].id);
            } else {
                console.warn("Playlist is empty. Cannot start playing videos.");
            }
        }

        // 4. This function handles when a video ends or changes state.
        function onPlayerStateChange(event) {
            console.log("Player State Changed:", event.data);
            // Clear any previous timer and hide placeholder whenever player state changes
            clearTimeout(placeholderTimerId);
            endingPlaceholder.style.display = 'none';

            if (event.data == YT.PlayerState.ENDED) {
                console.log("Video ended. Playing next...");
                playNext(); // Automatically play next video when current one ends
            } else if (event.data == YT.PlayerState.PLAYING) {
                // Set timer only when the video starts playing
                const duration = player.getDuration(); // Total video duration in seconds
                const currentTime = player.getCurrentTime(); // Current playback time in seconds

                console.log(`Video playing. Duration: ${duration}s, Current Time: ${currentTime}s`);

                // Calculate time left from current position until SECONDS_BEFORE_END_TO_SHOW_PLACEHOLDER before end
                const timeRemainingUntilPlaceholder = (duration - SECONDS_BEFORE_END_TO_SHOW_PLACEHOLDER) - currentTime;

                console.log(`Placeholder should appear in approximately: ${timeRemainingUntilPlaceholder.toFixed(2)}s`);

                if (duration > SECONDS_BEFORE_END_TO_SHOW_PLACEHOLDER && timeRemainingUntilPlaceholder > 0) {
                    placeholderTimerId = setTimeout(() => {
                        console.log("TIMEOUT FIRED! Showing placeholder.");
                        endingPlaceholder.style.display = 'block'; // Show the placeholder
                    }, timeRemainingUntilPlaceholder * 1000); // Convert seconds to milliseconds
                } else if (duration > 0 && duration <= SECONDS_BEFORE_END_TO_SHOW_PLACEHOLDER) {
                    console.log(`Video is shorter than ${SECONDS_BEFORE_END_TO_SHOW_PLACEHOLDER} seconds. Placeholder will not show.`);
                } else if (timeRemainingUntilPlaceholder <= 0 && duration > SECONDS_BEFORE_END_TO_SHOW_PLACEHOLDER) {
                    console.log(`Already past the ${SECONDS_BEFORE_END_TO_SHOW_PLACEHOLDER} second mark. Placeholder won't be set for this video.`);
                }
            }
        }

        // 5. Fetches the playlist from your Render server
        async function fetchAndPopulateVideos() {
            console.log("Fetching playlist from:", renderServerUrl + "/playlist");
            try {
                const response = await fetch(`${renderServerUrl}/playlist`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                playlist = await response.json();
                console.log("Playlist fetched:", playlist);
                if (playlist.length === 0) {
                    console.warn("Playlist is empty. Please ensure your Render server is returning videos.");
                }
            } catch (error) {
                console.error("Could not fetch playlist:", error);
                alert("Error loading playlist. Check your Render server URL and ensure it's running.");
            }
        }

        // 6. Loads and plays a specific YouTube video ID
        function loadAndPlayVideo(videoId) {
            console.log("Loading video ID:", videoId);
            if (player && videoId) {
                // Clear any existing timer and hide placeholder immediately when a new video loads
                clearTimeout(placeholderTimerId);
                endingPlaceholder.style.display = 'none';

                player.loadVideoById(videoId);
                updateVideoTitle();
            } else {
                console.error("Player not ready or videoId is missing.");
            }
        }

        // 7. Updates the title displayed above the player
        function updateVideoTitle() {
            if (currentVideoIndex >= 0 && currentVideoIndex < playlist.length) {
                document.getElementById('videoTitle').textContent = playlist[currentVideoIndex].title;
            } else {
                document.getElementById('videoTitle').textContent = "No video loaded";
            }
        }

        // 8. Function to automatically play the next video in sequence
        function playNext() {
            if (playlist.length === 0) {
                console.warn("Playlist is empty. Cannot play next video.");
                return;
            }
            currentVideoIndex = (currentVideoIndex + 1) % playlist.length; // Loop back to start
            console.log("Playing next video. New index:", currentVideoIndex);
            loadAndPlayVideo(playlist[currentVideoIndex].id);
        }

        // 9. New function to unmute the video
        function unmuteVideo() {
            if (player && player.isMuted()) {
                player.unMute();
                console.log("Video unmuted.");
                // Optional: You can hide the unmute button after it's clicked if you prefer
                // document.getElementById('unmuteButton').style.display = 'none';
            } else if (player) {
                console.log("Video is already unmuted.");
            } else {
                console.warn("Player not ready to unmute.");
            }
        }
    </script>
</body>
</html>
