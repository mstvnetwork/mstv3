<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live TV Playlist (Local Time Support)</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #player { width: 100%; height: 480px; background: black; }
    #current-title { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

<h2>Live Broadcast (AEST Time-Based)</h2>
<div id="player"></div>
<div id="current-title">Loading playlist...</div>

<script>
  const playlistUrl = 'https://raw.githubusercontent.com/your-username/your-repo/main/playlist.json';
  let playlist = [];
  let currentPlayer = null;
  let currentVideo = null;

  async function fetchPlaylist() {
    try {
      const response = await fetch(playlistUrl);
      playlist = await response.json();
      checkAndPlayCurrentVideo();
      setInterval(checkAndPlayCurrentVideo, 30000); // check every 30s
    } catch (err) {
      console.error('Failed to load playlist:', err);
      document.getElementById('current-title').innerText = 'Error loading playlist.';
    }
  }

  function checkAndPlayCurrentVideo() {
    const now = new Date();

    for (const video of playlist) {
      const start = new Date(video.startTime); // automatically parsed with timezone
      const end = new Date(video.endTime);

      if (now >= start && now < end) {
        if (!currentVideo || currentVideo.url !== video.url) {
          currentVideo = video;
          playVideo(video);
        }
        return;
      }
    }

    document.getElementById('current-title').innerText = 'No broadcast right now.';
    clearPlayer();
  }

  function playVideo(video) {
    document.getElementById('current-title').innerText = `Now Playing: ${video.title}`;
    const playerContainer = document.getElementById('player');
    playerContainer.innerHTML = '';

    if (video.type === 'youtube') {
      const ytId = getYouTubeID(video.url);
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${ytId}?autoplay=1&mute=1`;
      iframe.allow = 'autoplay; encrypted-media';
      iframe.width = '100%';
      iframe.height = '100%';
      iframe.frameBorder = 0;
      playerContainer.appendChild(iframe);
      currentPlayer = iframe;
    } else if (video.type === 'hls') {
      const videoEl = document.createElement('video');
      videoEl.controls = true;
      videoEl.autoplay = true;
      videoEl.style.width = '100%';
      videoEl.style.height = '100%';
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(video.url);
        hls.attachMedia(videoEl);
      } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
        videoEl.src = video.url;
      }
      playerContainer.appendChild(videoEl);
      currentPlayer = videoEl;
    }
  }

  function clearPlayer() {
    const playerContainer = document.getElementById('player');
    playerContainer.innerHTML = '';
    currentPlayer = null;
  }

  function getYouTubeID(url) {
    const regExp = /(?:youtube\.com.*(?:\?|&)v=|youtu\.be\/)([^&#]+)/;
    const match = url.match(regExp);
    return match ? match[1] : null;
  }

  fetchPlaylist();
</script>

</body>
</html>
