<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>MSTV Live Playlist</title>
  <style>
    body {
      font-family: sans-serif;
      background: #000;
      color: #eee;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    #player {
      max-width: 720px;
      margin: 0 auto;
    }
    video, iframe {
      width: 100%;
      height: 405px;
      background: #111;
      border-radius: 8px;
    }
    #status, #countdown, #elapsed-time {
      margin-top: 10px;
    }
    ul#playlist {
      list-style: none;
      padding: 0;
      max-width: 720px;
      margin: 20px auto;
      text-align: left;
    }
    ul#playlist li {
      padding: 8px;
      border-bottom: 1px solid #444;
    }
    ul#playlist li.current {
      background: #007acc;
      color: white;
      font-weight: bold;
    }

    /* ðŸ“º TV Guide Table */
    #guide {
      max-width: 720px;
      margin: 30px auto;
      border-collapse: collapse;
      width: 100%;
    }
    #guide th, #guide td {
      padding: 10px;
      border: 1px solid #333;
    }
    #guide .now {
      background: #007acc;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¥ MSTV Live Playlist</h1>
  <div id="player">
    <div id="elapsed-time"></div>
  </div>
  <div id="status">Loading...</div>
  <div id="countdown"></div>
  <ul id="playlist"></ul>
  <h2>ðŸ“º Today's TV Guide</h2>
  <table id="guide">
    <thead>
      <tr><th>Start</th><th>End</th><th>Title</th></tr>
    </thead>
    <tbody></tbody>
  </table>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
const playlistUrl = 'playlist.json';
const startHour = 8; // Broadcast starts daily at 8:00 AM local time

const playerDiv = document.getElementById('player');
const status = document.getElementById('status');
const countdown = document.getElementById('countdown');
const playlistEl = document.getElementById('playlist');
const guideEl = document.querySelector('#guide tbody');
const elapsedTimeEl = document.getElementById('elapsed-time');

function getStartOfDayTime(hour) {
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, 0, 0, 0);
}

function getTimeOffsetSeconds(startTime) {
  const now = new Date();
  return Math.max(0, Math.floor((now - startTime) / 1000));
}

function formatTime(seconds) {
  const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
  const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
  return `${h}:${m}`;
}

function extractYouTubeId(url) {
  const match = url.match(/v=([^&]+)/);
  return match ? match[1] : null;
}

async function fetchPlaylist() {
  const res = await fetch(playlistUrl);
  return await res.json();
}

function findCurrentTrack(playlist, elapsed) {
  const total = playlist.reduce((acc, cur) => acc + cur.duration, 0);
  elapsed = elapsed % total;

  let acc = 0;
  for (let i = 0; i < playlist.length; i++) {
    const item = playlist[i];
    if (acc + item.duration > elapsed) {
      return {
        item,
        index: i,
        offset: elapsed - acc
      };
    }
    acc += item.duration;
  }
  return null;
}

function renderPlaylist(playlist, currentIndex) {
  playlistEl.innerHTML = '';
  playlist.forEach((item, i) => {
    const li = document.createElement('li');
    li.textContent = item.title || item.url;
    if (i === currentIndex) li.classList.add('current');
    playlistEl.appendChild(li);
  });
}

function renderGuide(playlist, startHour, currentIndex, currentOffset) {
  guideEl.innerHTML = '';
  let time = new Date();
  time.setHours(startHour, 0, 0, 0);

  playlist.forEach((item, index) => {
    const start = new Date(time);
    const end = new Date(time.getTime() + item.duration * 1000);
    const tr = document.createElement('tr');

    if (index === currentIndex) tr.classList.add('now');

    tr.innerHTML = `
      <td>${start.toTimeString().slice(0,5)}</td>
      <td>${end.toTimeString().slice(0,5)}</td>
      <td>${item.title || item.url}</td>
    `;
    guideEl.appendChild(tr);
    time = end;
  });
}

function loadPlayer(item, offset) {
  playerDiv.innerHTML = ''; // Clear previous
  status.textContent = `Now playing: ${item.title || item.type} | Offset: ${offset}s`;

  if (item.type === 'youtube' || item.type === 'youtube-live') {
  const id = extractYouTubeId(item.url);
  const startParam = item.type === 'youtube' ? `&start=${offset}` : '';
  const embedUrl = `https://www.youtube.com/embed/${id}?autoplay=1&controls=1&rel=0${startParam}`;
  const iframe = document.createElement('iframe');
  iframe.src = embedUrl;
  iframe.frameBorder = '0';
  iframe.allow = 'autoplay; encrypted-media';
  iframe.allowFullscreen = true;
  playerDiv.appendChild(iframe);
}

    const id = extractYouTubeId(item.url);
    const startParam = `&start=${offset}`;
    const embedUrl = `https://www.youtube.com/embed/${id}?autoplay=1&controls=1&rel=0${startParam}`;
    const iframe = document.createElement('iframe');
    iframe.src = embedUrl;
    iframe.frameBorder = '0';
    iframe.allow = 'autoplay; encrypted-media';
    iframe.allowFullscreen = true;
    playerDiv.appendChild(iframe);
  } else if (item.type === 'mp4' || item.type === 'hls') {
    const video = document.createElement('video');
    video.controls = true;
    video.autoplay = true;

    if (item.type === 'mp4') {
      video.src = item.url;
      video.addEventListener('loadedmetadata', () => {
        if (video.duration > offset) video.currentTime = offset;
      });
    } else {
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(item.url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.currentTime = offset;
          video.play();
        });
      } else {
        video.src = item.url;
        video.currentTime = offset;
      }
    }
    playerDiv.appendChild(video);
  } else {
    status.textContent = 'Unsupported media type: ' + item.type;
  }
}

(async function init() {
  const startTime = getStartOfDayTime(startHour);
  const playlist = await fetchPlaylist();
  if (!playlist || playlist.length === 0) {
    status.textContent = 'Playlist not found or empty.';
    return;
  }

  function update() {
    const elapsed = getTimeOffsetSeconds(startTime);
    const current = findCurrentTrack(playlist, elapsed);
    if (!current) return;

    renderPlaylist(playlist, current.index);
    renderGuide(playlist, startHour, current.index, current.offset);
    loadPlayer(current.item, current.offset);

    // Update countdown & elapsed time
    const remaining = current.item.duration - current.offset;
    countdown.textContent = `Next video in: ${formatTime(remaining)}`;
    elapsedTimeEl.textContent = `Elapsed: ${formatTime(current.offset)}`;
  }

  update();
  setInterval(() => {
    const elapsed = getTimeOffsetSeconds(startTime);
    const current = findCurrentTrack(playlist, elapsed);
    if (!current) return;
    renderPlaylist(playlist, current.index);
    renderGuide(playlist, startHour, current.index, current.offset);

    const rem = current.item.duration - current.offset;
    countdown.textContent = `Next video in: ${formatTime(rem)}`;
    elapsedTimeEl.textContent = `Elapsed: ${formatTime(current.offset)}`;
  }, 1000);
})();
</script>
</body>
</html>
