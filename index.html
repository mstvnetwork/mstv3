<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Live TV Channel</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            color: #f0f0f0; /* Light text */
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .tv-container {
            width: 90%; /* Adjust as needed */
            max-width: 1280px; /* Max width for large screens, e.g., 720p or 1080p aspect */
            border-radius: 10px;
            overflow: hidden; /* Crucial for hiding parts of the scrolling text outside the container */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background-color: #2a2a2a;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio (height / width * 100) */
            height: 0;
            overflow: hidden;
            background-color: black; /* Background for when video is loading */
        }

        /* Adjusted CSS for dynamic players: target children of player-wrapper */
        #player-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; /* Use flexbox to center content */
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Important for containing video */
        }

        /* This targets the dynamically created YouTube iframe div */
        #player-wrapper > div {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            position: absolute; /* Take full space within wrapper */
        }

        /* This targets the dynamically created HTML5 video element */
        #player-wrapper > video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain; /* Or 'cover' based on preference */
            position: absolute; /* Take full space within wrapper */
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: auto;
            /* background: rgba(255, 0, 0, 0.1); /* Uncomment for debugging to see the overlay */
        }

        /* Thumbnail Placeholder Styling */
        .video-thumbnail-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000; /* Black background behind thumbnail */
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 12;
            display: none;
            transition: opacity 0.3s ease;
            opacity: 0;
        }

        /* Custom Unmute Button */
        .unmute-button {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 4.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .unmute-button:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .unmute-button .mute-icon { display: none; }
        .unmute-button.muted .mute-icon { display: inline-block; }
        .unmute-button.muted .unmute-icon { display: none; }
        .unmute-button:not(.muted) .mute-icon { display: none; }
        .unmute-button:not(.muted) .unmute-icon { display: inline-block; }

        /* Scrolling Text Container */
        .scrolling-text-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background-color: red;
            overflow: hidden;
            z-index: 15;
            display: flex;
            align-items: center;
            white-space: nowrap;
            box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.3);
        }

        .scrolling-text {
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            padding-left: 100%;
            animation: scroll-left 40s linear infinite;
        }

        @keyframes scroll-left {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-100%); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tv-container {
                width: 95%;
            }
            .unmute-button {
                top: 10px;
                right: 10px;
                padding: 10px;
                font-size: 3.0em;
            }
            .scrolling-text-container {
                height: 30px;
            }
            .scrolling-text {
                font-size: 1em;
                animation-duration: 30s;
            }
        }

        @media (max-width: 480px) {
            .tv-container {
                width: 100%;
                border-radius: 0;
            }
            .unmute-button {
                top: 5px;
                right: 5px;
                padding: 8px;
                font-size: 2.0em;
            }
            .scrolling-text-container {
                height: 25px;
            }
            .scrolling-text {
                font-size: 0.9em;
                animation-duration: 25s;
            }
        }
    </style>
</head>
<body>

    <div class="tv-container">
        <div class="video-container">
            <div id="player-wrapper">
                </div>
            <div class="video-overlay"></div>
            <div class="video-thumbnail-placeholder" id="videoThumbnail"></div>

            <button id="unmuteButton" class="unmute-button muted">
                <span class="mute-icon">ðŸ”‡</span>
                <span class="unmute-icon">ðŸ”Š</span>
            </button>

            <div class="scrolling-text-container">
                <div class="scrolling-text" id="newsTicker">
                    Welcome to My Live TV Channel! Tune in 24/7 for great content. Stay tuned for exciting upcoming programs! This is a demo of scrolling text.
                    Â Â Â Â Â Â Â Â Â Â Â Â Â  Breaking News: Live broadcast continues! Â Â Â Â Â Â Â Â Â Â Â Â Â  
                    Remember to unmute for sound! Â Â Â Â Â Â Â Â Â Â Â Â Â  
                    Enjoy the show!
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global Flags for API readiness ---
        let youtubeApiReady = false;
        let hlsJsReady = false;

        // --- Helper function to parse various YouTube/M3U8 URLs/IDs ---
        function parseMediaLink(link) {
            const youtubeVideoRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const m3u8Regex = /\.m3u8(?:$|\?)/i;

            let match;

            if (m3u8Regex.test(link)) {
                return { type: 'm3u8', url: link };
            }

            match = link.match(youtubeVideoRegex);
            if (match && match[1]) {
                return { type: 'youtube', id: match[1] };
            }

            if (link.length === 11 && /^[a-zA-Z0-9_-]+$/.test(link)) {
                return { type: 'youtube', id: link };
            }

            console.warn(`Unrecognized media link format: ${link}`);
            return null;
        }

        // --- YOUR 24/7 CONTINUOUS PLAYLIST (Mix YouTube IDs/URLs and M3U8 URLs) ---
        const mediaPlaylist = [
            '17LL_iqlHE8', // YouTube: Rick Astley
            'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8', // M3U8: Example HLS stream (Public Test Stream)
            'xHs7aUUOlJo', // YouTube: Lofi Hip Hop Radio
            'https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8', // M3U8: Another example HLS (Public Test Stream)
            'RQqYw5nJK7A', // YouTube: Epic Nature Documentary
            'P-0EiCkAFnE', // YouTube: Cozy Fireplace Sounds
            'https://mnmedias.api.telequebec.tv/m3u8/29880.m3u8', // M3U8: Another public test stream
            // Add more video IDs or full URLs (YouTube or M3U8) here.
        ];

        // --- CONFIGURATION FOR VIDEO SLOTS ---
        const VIDEO_SLOT_DURATION_SECONDS = 60; // Each video/stream will play for 1 minute for quicker testing

        // Global state variables
        const LAST_PLAYED_KEY = 'lastPlayedMedia';
        let currentMediaIndex = 0;
        let youtubePlayer = null; // Reference to YouTube player instance
        let html5VideoElement = null; // Reference to HTML5 video element
        let hlsPlayer = null; // Reference to hls.js instance
        let currentPlayingType = null; // 'youtube' or 'm3u8'
        let saveInterval;
        let mediaTimeout;

        const unmuteButton = document.getElementById('unmuteButton');
        const newsTicker = document.getElementById('newsTicker');
        const videoThumbnail = document.getElementById('videoThumbnail');
        const playerWrapper = document.getElementById('player-wrapper');

        // Helper function to get YouTube thumbnail URL
        function getYouTubeThumbnailUrl(videoId) {
            // Using 'hqdefault' as it's generally available and good quality.
            // 'maxresdefault' is highest but not always exists.
            return `http://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        }

        // Function to display the thumbnail
        function displayThumbnail(mediaItem) {
            let thumbnailUrl = '';
            if (mediaItem && mediaItem.type === 'youtube') {
                thumbnailUrl = getYouTubeThumbnailUrl(mediaItem.id);
                videoThumbnail.style.backgroundSize = 'contain';
            } else if (mediaItem && mediaItem.type === 'm3u8') {
                // For M3U8, use a generic loading image or just black.
                // You can replace this with a URL to a specific "Loading Live Stream..." image
                thumbnailUrl = ''; // Default to black background
                videoThumbnail.style.backgroundSize = 'cover';
            } else {
                thumbnailUrl = '';
            }

            videoThumbnail.style.backgroundImage = thumbnailUrl ? `url('${thumbnailUrl}')` : 'none';
            videoThumbnail.style.backgroundColor = '#000';
            videoThumbnail.style.display = 'block';
            videoThumbnail.offsetHeight; // Trigger reflow for transition
            videoThumbnail.style.opacity = '1';
        }

        // Function to hide the thumbnail
        function hideThumbnail() {
            videoThumbnail.style.opacity = '0';
            setTimeout(() => {
                videoThumbnail.style.display = 'none';
                videoThumbnail.style.backgroundImage = 'none';
            }, 300); // Match CSS transition duration
        }

        // --- Player Management Functions ---
        function destroyCurrentPlayer() {
            console.log(`Destroying current player (${currentPlayingType})...`);
            if (currentPlayingType === 'youtube' && youtubePlayer) {
                try {
                    youtubePlayer.destroy();
                } catch (e) {
                    console.warn("Error destroying YouTube player:", e);
                }
                youtubePlayer = null;
            } else if (currentPlayingType === 'm3u8' && html5VideoElement) {
                if (hlsPlayer) {
                    try {
                        hlsPlayer.stopLoad(); // Stop current HLS stream
                        hlsPlayer.destroy();
                    } catch (e) {
                        console.warn("Error destroying HLS.js player:", e);
                    }
                    hlsPlayer = null;
                }
                html5VideoElement.removeEventListener('ended', onHtml5VideoEnded);
                html5VideoElement.removeEventListener('play', onHtml5VideoPlaying);
                html5VideoElement.removeEventListener('error', onHtml5VideoError);
                html5VideoElement.pause();
                html5VideoElement.src = ''; // Clear source to stop download
                html5VideoElement.load(); // Request browser to unload media
                
                if (html5VideoElement.parentNode) {
                    html5VideoElement.parentNode.removeChild(html5VideoElement);
                }
                html5VideoElement = null;
            }
            playerWrapper.innerHTML = ''; // Ensure the wrapper is empty
            currentPlayingType = null;
            console.log("Current player destroyed.");
        }

        function createYouTubePlayer(videoId, startTime) {
            destroyCurrentPlayer(); // Clean up previous player
            const div = document.createElement('div');
            div.id = 'youtube-player-iframe-placeholder'; // Unique ID for YT API
            playerWrapper.appendChild(div);

            youtubePlayer = new YT.Player(div.id, {
                height: '390',
                width: '640',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'controls': 0,
                    'disablekb': 1,
                    'autohide': 1,
                    'modestbranding': 1,
                    'rel': 0,
                    'iv_load_policy': 3,
                    'start': startTime // Set start time for YouTube
                },
                events: {
                    'onReady': onYouTubePlayerReady,
                    'onStateChange': onYouTubePlayerStateChange,
                    'onError': onYouTubePlayerError
                }
            });
            currentPlayingType = 'youtube';
        }

        function createHtml5VideoPlayer(url) { 
            destroyCurrentPlayer(); // Clean up previous player
            html5VideoElement = document.createElement('video');
            html5VideoElement.id = 'html5-video-player'; // Assign ID for CSS targeting
            html5VideoElement.controls = false;
            html5VideoElement.autoplay = true;
            html5VideoElement.playsInline = true;
            playerWrapper.appendChild(html5VideoElement);

            html5VideoElement.addEventListener('ended', onHtml5VideoEnded);
            html5VideoElement.addEventListener('play', onHtml5VideoPlaying);
            html5VideoElement.addEventListener('error', onHtml5VideoError);
            html5VideoElement.addEventListener('loadedmetadata', function() {
                // For live streams, we generally start at the live edge.
                console.log(`HTML5 loadedmetadata for ${url}. Starting from live point.`);
                html5VideoElement.play().catch(e => console.warn("HTML5 video auto-play prevented:", e.message));
            }, { once: true });

            if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                hlsPlayer = new Hls();
                hlsPlayer.loadSource(url);
                hlsPlayer.attachMedia(html5VideoElement);
                console.log("HLS.js attached and loading source.");

                hlsPlayer.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS.js error:', data);
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.error("HLS Network Error, attempting to recover...");
                                hlsPlayer.recoverMediaError();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.error("HLS Media Error, attempting to recover...");
                                hlsPlayer.recoverMediaError();
                                break;
                            default:
                                console.error("Fatal HLS error, skipping to next media.");
                                onHtml5VideoError({ target: html5VideoElement, type: 'fatal_hls_error' });
                                break;
                        }
                    }
                });
            } else if (html5VideoElement.canPlayType('application/vnd.apple.mpegurl')) {
                console.log("Browser supports native HLS playback.");
                html5VideoElement.src = url;
            } else {
                console.error('Neither HLS.js nor native HLS is supported in this browser. Skipping to next media.');
                currentMediaIndex++;
                loadPlaylistItem();
                return;
            }
            currentPlayingType = 'm3u8';
            checkMuteStateAndApply();
        }

        // Function to load the current item from the playlist
        function loadPlaylistItem(isInitialLoad = false) {
            if (!youtubeApiReady || !hlsJsReady) {
                console.log("APIs not fully ready yet, delaying loadPlaylistItem.");
                return;
            }

            let startTime = 0;
            
            if (isInitialLoad) {
                const lastPlayed = JSON.parse(localStorage.getItem(LAST_PLAYED_KEY));
                if (lastPlayed && mediaPlaylist[lastPlayed.index]) {
                    const savedMediaInfo = parseMediaLink(mediaPlaylist[lastPlayed.index]);
                    
                    let isMatch = false;
                    if (savedMediaInfo && savedMediaInfo.type === lastPlayed.type) {
                        if (savedMediaInfo.type === 'youtube' && savedMediaInfo.id === lastPlayed.id) {
                            isMatch = true;
                        } else if (savedMediaInfo.type === 'm3u8' && savedMediaInfo.url === lastPlayed.url) {
                            isMatch = true; 
                        }
                    }

                    if (isMatch) {
                        currentMediaIndex = lastPlayed.index;
                        if (lastPlayed.type === 'youtube') { 
                            startTime = lastPlayed.time;
                            console.log(`Resuming YouTube from saved state: Index ${currentMediaIndex}, Time ${startTime}s.`);
                        } else { // M3U8 (Live stream)
                            console.log(`Resuming M3U8 stream from saved state (live point): Index ${currentMediaIndex}.`);
                            // No 'startTime' for M3U8 as it's live
                        }
                    } else {
                        console.warn("Saved media item does not match current playlist or identifier. Starting from beginning.");
                        currentMediaIndex = 0;
                        startTime = 0;
                    }
                } else {
                    console.log("No saved state found or invalid. Starting from beginning.");
                    currentMediaIndex = 0;
                    startTime = 0;
                }
            }


            if (currentMediaIndex >= mediaPlaylist.length) {
                currentMediaIndex = 0; // Loop back to the beginning
            }

            const itemToPlay = mediaPlaylist[currentMediaIndex];
            const parsedItem = parseMediaLink(itemToPlay);

            if (!parsedItem) {
                console.error(`Skipping unrecognized item in playlist at index ${currentMediaIndex}: ${itemToPlay}. Moving to next.`);
                currentMediaIndex++;
                loadPlaylistItem(); // Try next item immediately
                return;
            }

            console.log(`Preparing to load ${parsedItem.type} item:`, parsedItem);
            
            displayThumbnail(parsedItem);

            // Create the appropriate player
            if (parsedItem.type === 'youtube') {
                createYouTubePlayer(parsedItem.id, startTime);
            } else if (parsedItem.type === 'm3u8') {
                createHtml5VideoPlayer(parsedItem.url); 
            }

            // Clear any existing timeout. The new timeout will be set when video actually plays (onPlaying event).
            clearTimeout(mediaTimeout); 
        }

        // --- YouTube Player Event Handlers ---
        function onYouTubeIframeAPIReady() {
            console.log("YouTube IFrame API is ready.");
            youtubeApiReady = true;
            if (hlsJsReady) {
                loadPlaylistItem(true); // Initial load, check for saved state
                startSaveInterval();
            }
        }

        function onYouTubePlayerReady(event) {
            console.log("YouTube player instance ready.");
            checkMuteStateAndApply();
        }

        function onYouTubePlayerStateChange(event) {
            console.log("YouTube Player State Changed:", event.data);
            if (event.data === YT.PlayerState.ENDED) {
                console.log(`YouTube video naturally ended. Moving to next.`);
                clearTimeout(mediaTimeout);
                currentMediaIndex++;
                const nextMedia = mediaPlaylist[currentMediaIndex % mediaPlaylist.length];
                displayThumbnail(parseMediaLink(nextMedia));
                loadPlaylistItem();
            } else if (event.data === YT.PlayerState.PLAYING) {
                hideThumbnail();
                clearTimeout(mediaTimeout);
                const playedTime = youtubePlayer.getCurrentTime() || 0;
                const remainingTime = VIDEO_SLOT_DURATION_SECONDS * 1000 - (playedTime * 1000);
                mediaTimeout = setTimeout(() => {
                    console.log(`${VIDEO_SLOT_DURATION_SECONDS}-second slot ended (YouTube PLAYING). Moving to next.`);
                    currentMediaIndex++;
                    loadPlaylistItem();
                }, Math.max(0, remainingTime));
            } else if (event.data === YT.PlayerState.BUFFERING) {
                console.log("YouTube player buffering, showing thumbnail.");
                const currentMedia = mediaPlaylist[currentMediaIndex];
                displayThumbnail(parseMediaLink(currentMedia));
            }
        }

        function onYouTubePlayerError(event) {
            console.error('YouTube Player Error:', event.data, 'Attempting to skip to next item.');
            clearTimeout(mediaTimeout);
            currentMediaIndex++;
            const nextMedia = mediaPlaylist[currentMediaIndex % mediaPlaylist.length];
            displayThumbnail(parseMediaLink(nextMedia));
            loadPlaylistItem();
        }

        // --- HTML5 Video Player Event Handlers ---
        function onHtml5VideoEnded() {
            console.log(`HTML5 video naturally ended. Moving to next.`);
            clearTimeout(mediaTimeout);
            currentMediaIndex++;
            const nextMedia = mediaPlaylist[currentMediaIndex % mediaPlaylist.length];
            displayThumbnail(parseMediaLink(nextMedia));
            loadPlaylistItem();
        }

        function onHtml5VideoPlaying() {
            console.log("HTML5 video playing.");
            hideThumbnail();
            clearTimeout(mediaTimeout);
            const playedTime = html5VideoElement.currentTime || 0; 
            const remainingTime = VIDEO_SLOT_DURATION_SECONDS * 1000 - (playedTime * 1000);
            mediaTimeout = setTimeout(() => {
                console.log(`${VIDEO_SLOT_DURATION_SECONDS}-second slot ended (HTML5 PLAYING). Moving to next.`);
                currentMediaIndex++;
                loadPlaylistItem();
            }, Math.max(0, remainingTime));
        }

        function onHtml5VideoError(event) {
            console.error('HTML5 Video Error:', event, 'Attempting to skip to next item.');
            clearTimeout(mediaTimeout);
            currentMediaIndex++;
            const nextMedia = mediaPlaylist[currentMediaIndex % mediaPlaylist.length];
            displayThumbnail(parseMediaLink(nextMedia));
            loadPlaylistItem();
        }

        // --- Mute/Unmute Logic ---
        function checkMuteStateAndApply() {
            const shouldBeMuted = unmuteButton.classList.contains('muted');
            console.log(`Applying mute state: ${shouldBeMuted ? 'Muted' : 'Unmuted'}`);

            if (currentPlayingType === 'youtube' && youtubePlayer) {
                if (shouldBeMuted) {
                    youtubePlayer.mute();
                } else {
                    youtubePlayer.unMute();
                }
            } else if (currentPlayingType === 'm3u8' && html5VideoElement) {
                html5VideoElement.muted = shouldBeMuted;
            }
        }

        unmuteButton.addEventListener('click', () => {
            unmuteButton.classList.toggle('muted');
            checkMuteStateAndApply();
        });

        // --- Save Playback Position ---
        function startSaveInterval() {
            clearInterval(saveInterval); 
            saveInterval = setInterval(() => {
                let currentTime = 0;
                let mediaIdentifier = ''; 
                let typeToSave = currentPlayingType;

                if (currentPlayingType === 'youtube' && youtubePlayer && typeof youtubePlayer.getCurrentTime === 'function') {
                    currentTime = youtubePlayer.getCurrentTime();
                    const url = youtubePlayer.getVideoUrl();
                    const match = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                    mediaIdentifier = match ? match[1] : '';
                } else if (currentPlayingType === 'm3u8' && html5VideoElement) {
                    currentTime = 0; // Always 0 for live M3U8, as we don't "resume" a live point
                    mediaIdentifier = html5VideoElement.src;
                }
                
                localStorage.setItem(LAST_PLAYED_KEY, JSON.stringify({
                    index: currentMediaIndex,
                    type: typeToSave,
                    id: typeToSave === 'youtube' ? mediaIdentifier : undefined,
                    url: typeToSave === 'm3u8' ? mediaIdentifier : undefined,
                    time: currentTime
                }));
            }, 5000); 
        }

        // --- Initialization ---
        if (typeof Hls !== 'undefined') {
            console.log("HLS.js library found and ready.");
            hlsJsReady = true;
        } else {
            console.error("HLS.js library not found. M3U8 playback will not work. Ensure the HLS.js CDN URL is correct.");
        }

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api"; // OFFICIAL YouTube API URL
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.addEventListener('beforeunload', () => {
            clearInterval(saveInterval);
            clearTimeout(mediaTimeout);
            destroyCurrentPlayer();
            // localStorage.removeItem(LAST_PLAYED_KEY); // Uncomment if you DO NOT want state to persist
        });
    </script>

</body>
</html>
