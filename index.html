<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MSTV Live TV Channel</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .player-container {
      position: relative;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .video-player {
      width: 100%;
      height: 500px;
    }
    .status-bar {
      display: flex;
      justify-content: space-between;
      background: #222;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .playlist-info, .tv-guide {
      background: #1c1c1c;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .tv-guide-entry {
      padding: 10px;
      border-bottom: 1px solid #333;
    }
    .tv-guide-entry.current {
      background: #333;
      border-left: 4px solid #4ecdc4;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>MSTV Live TV Channel</h1>
    <p>Broadcasting your curated content 24/7</p>
  </div>

  <div class="player-container">
    <div id="playerFrame" class="video-player">
      <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
        <span>Loading player...</span>
      </div>
    </div>
    <div class="status-bar">
      <div><strong>Status:</strong> <span id="statusText">Loading...</span></div>
      <div><strong>Time:</strong> <span id="currentTime"></span></div>
    </div>
  </div>

  <div class="playlist-info">
    <strong>Now Playing:</strong> <span id="currentTitle">-</span><br>
    <strong>Progress:</strong> <span id="playbackProgress">-</span><br>
    <strong>Next Up:</strong> <span id="nextItem">-</span>
  </div>

  <div class="tv-guide">
    <h3>Today's TV Guide</h3>
    <div id="tvGuideList"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
  const PLAYLIST_URL = 'https://raw.githubusercontent.com/mstvnetwork/mstv3/main/playlist.json';
  let playlist = [];
  let currentIndex = -1;
  let startTimeEpoch = Date.now();

  function parseDurationToSeconds(duration) {
    const parts = duration.split(':').map(Number);
    if (parts.length === 3) return parts[0]*3600 + parts[1]*60 + parts[2];
    if (parts.length === 2) return parts[0]*60 + parts[1];
    return 300;
  }

  function formatTime(seconds) {
    const date = new Date(seconds * 1000);
    return date.toISOString().substr(11, 5);
  }

  function updateClock() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString();
  }

  setInterval(updateClock, 1000);

  function isYouTubeURL(url) {
    return /youtu(be\.com|\.be)/.test(url);
  }

  function extractYouTubeID(url) {
    const match = url.match(/(?:youtube\.com.*(?:v=|\/embed\/)|youtu\.be\/)([^\s&?/]+)/);
    return match ? match[1] : null;
  }

  function loadPlayer(item, elapsed) {
    const container = document.getElementById('playerFrame');
    const url = item.url;
    if (isYouTubeURL(url)) {
      const id = extractYouTubeID(url);
      container.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id}?autoplay=1&start=${elapsed}" frameborder="0" allowfullscreen></iframe>`;
    } else if (url.includes('.m3u8')) {
      container.innerHTML = `<video id="m3u8Player" controls autoplay muted width="100%" height="100%" playsinline></video>`;
      const video = document.getElementById('m3u8Player');
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
      }
    } else {
      container.innerHTML = `<video src="${url}" width="100%" height="100%" controls autoplay muted playsinline></video>`;
    }
  }

  function updateUI(index, elapsed) {
    const current = playlist[index];
    const next = playlist[index + 1];
    const duration = parseDurationToSeconds(current.duration);
    const progress = Math.floor((elapsed / duration) * 100);
    document.getElementById('currentTitle').textContent = current.title;
    document.getElementById('playbackProgress').textContent = `${progress}%`;
    document.getElementById('nextItem').textContent = next ? next.title : 'End of playlist';
    document.getElementById('statusText').textContent = 'Live';
  }

  function renderTVGuide(startEpoch) {
    const guide = document.getElementById('tvGuideList');
    guide.innerHTML = '';
    let timeCursor = startEpoch;
    playlist.forEach((item, i) => {
      const duration = parseDurationToSeconds(item.duration);
      const start = new Date(timeCursor);
      const end = new Date(timeCursor + duration * 1000);
      const now = Date.now();
      const isCurrent = now >= timeCursor && now < (timeCursor + duration * 1000);
      const div = document.createElement('div');
      div.className = 'tv-guide-entry' + (isCurrent ? ' current' : '');
      div.textContent = `${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} :: ${item.title}`;
      guide.appendChild(div);
      timeCursor += duration * 1000;
    });
  }

  async function initLiveTV() {
    const res = await fetch(PLAYLIST_URL);
    playlist = await res.json();
    let totalSeconds = 0;
    const now = Date.now();
    const secondsSinceMidnight = Math.floor((now - new Date().setHours(0, 0, 0, 0)) / 1000);

    for (let i = 0; i < playlist.length; i++) {
      const dur = parseDurationToSeconds(playlist[i].duration);
      if (totalSeconds + dur > secondsSinceMidnight) {
        currentIndex = i;
        const elapsed = secondsSinceMidnight - totalSeconds;
        loadPlayer(playlist[i], elapsed);
        updateUI(i, elapsed);
        break;
      }
      totalSeconds += dur;
    }

    renderTVGuide(new Date().setHours(0,0,0,0));

    setInterval(() => {
      const elapsed = Math.floor((Date.now() - new Date().setHours(0, 0, 0, 0)) / 1000);
      let sum = 0;
      for (let i = 0; i < playlist.length; i++) {
        const dur = parseDurationToSeconds(playlist[i].duration);
        if (sum + dur > elapsed) {
          if (i !== currentIndex) {
            currentIndex = i;
            loadPlayer(playlist[i], elapsed - sum);
            updateUI(i, elapsed - sum);
          }
          break;
        }
        sum += dur;
      }
    }, 10000);
  }

  document.addEventListener('DOMContentLoaded', initLiveTV);
</script>
</body>
</html>
