<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MSTV Live TV Channel</title>
<style>
  body {
    margin: 0;
    background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .container {
    max-width: 1000px;
    margin: 20px auto;
    padding: 10px;
  }
  h1 {
    text-align: center;
    font-size: 2.5rem;
    margin-bottom: 0.3em;
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradientShift 4s ease infinite;
  }
  @keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }
  p.subtitle {
    text-align: center;
    font-size: 1.1rem;
    margin-bottom: 2rem;
    color: #ccc;
  }
  #playerContainer {
    position: relative;
    width: 100%;
    height: 540px;
    background: black;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.7);
    overflow: hidden;
  }
  #player {
    width: 100%;
    height: 100%;
    background: black;
  }
  #muteToggle {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    cursor: pointer;
    width: 70px;
    height: 70px;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.3s ease;
    opacity: 0.9;
    z-index: 10;
  }
  #muteToggle.hidden {
    opacity: 0;
    pointer-events: none;
  }
  #muteToggle svg {
    fill: white;
    width: 40px;
    height: 40px;
  }
  .status-bar {
    margin-top: 12px;
    display: flex;
    justify-content: space-between;
    font-size: 1rem;
    padding: 8px 12px;
    background: rgba(255 255 255 / 0.1);
    border-radius: 10px;
  }
  .status-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  #tvGuide {
    margin-top: 25px;
    font-size: 0.95rem;
    background: rgba(255 255 255 / 0.05);
    border-radius: 10px;
    padding: 12px 20px;
    max-height: 180px;
    overflow-y: auto;
    box-shadow: inset 0 0 8px rgba(0,0,0,0.2);
  }
  .guide-entry {
    margin-bottom: 6px;
  }
  .highlight {
    color: #4ecdc4;
    font-weight: 600;
  }
  .off-air {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #ff4757;
    font-size: 1.4rem;
    font-weight: bold;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>MSTV Live TV Channel</h1>
    <p class="subtitle">Broadcasting your curated content 24/7</p>

    <div id="playerContainer">
      <div id="player">Loading player...</div>
      <div id="muteToggle" title="Click to Unmute" class="hidden" aria-label="Mute Toggle Button">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M16.5 12a4.5 4.5 0 0 1-4.5 4.5v-9A4.5 4.5 0 0 1 16.5 12zM5 9v6h4l5 5V4L9 9H5zM19 12c0-1.77-1.02-3.29-2.5-4.03v8.06A4.49 4.49 0 0 0 19 12z"/>
        </svg>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-item"><strong>Status:</strong> <span id="statusText">Loading...</span></div>
      <div class="status-item"><strong>Time:</strong> <span id="currentTime"></span></div>
      <div class="status-item"><strong>Viewers:</strong> <span id="viewerCount">0</span></div>
    </div>

    <div class="status-bar" style="margin-top: 6px; font-weight: bold;">
      <span>Now Playing: <span id="nowTitle">-</span></span>
      <span> | Progress: <span id="nowProgress">-</span></span>
      <span> | Next Up: <span id="nextTitle">-</span></span>
    </div>

    <h3 style="margin-top: 30px;">Today's TV Guide</h3>
    <div id="tvGuide">Loading guide...</div>
    <div id="error" style="color: #ff6b6b; margin-top: 20px;"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
(() => {
  const playlistUrl = "https://raw.githubusercontent.com/mstvnetwork/mstv3/main/playlist.json";
  let playlist = [];
  let totalDuration = 0;
  let currentIndex = -1;
  let hlsPlayer = null;
  let videoElem = null;
  let muted = true;

  const playerDiv = document.getElementById("player");
  const statusText = document.getElementById("statusText");
  const nowTitle = document.getElementById("nowTitle");
  const nowProgress = document.getElementById("nowProgress");
  const nextTitle = document.getElementById("nextTitle");
  const viewerCount = document.getElementById("viewerCount");
  const tvGuide = document.getElementById("tvGuide");
  const errorBox = document.getElementById("error");
  const muteToggle = document.getElementById("muteToggle");

  function parseDuration(duration) {
    if (typeof duration === "number") return duration;
    const parts = duration.split(":").map(Number);
    return parts.reduce((acc, val, idx) => acc + val * Math.pow(60, parts.length - 1 - idx), 0);
  }

  function formatTime(seconds) {
    const d = new Date(seconds * 1000);
    return d.toISOString().substr(11, 5);
  }

  function formatClockTime(date) {
    return date.toLocaleTimeString();
  }

  function updateClock() {
    document.getElementById("currentTime").textContent = formatClockTime(new Date());
  }

  function updateViewers() {
    viewerCount.textContent = 50 + Math.floor(Math.random() * 150);
    setTimeout(updateViewers, 30000 + Math.random() * 15000);
  }

  function createTVGuide(playlist) {
    let html = "";
    let cursor = 0;
    playlist.forEach(item => {
      const duration = parseDuration(item.duration);
      const start = formatTime(cursor);
      const end = formatTime(cursor + duration);
      html += `<div class="guide-entry">${start} - ${end} :: <span class="highlight">${item.title || "Untitled"}</span></div>`;
      cursor += duration;
    });
    tvGuide.innerHTML = html;
  }

  function showOffAir(msg = "Off Air") {
    if (hlsPlayer) {
      hlsPlayer.destroy();
      hlsPlayer = null;
    }
    playerDiv.innerHTML = `<div class="off-air">${msg}</div>`;
    statusText.textContent = "Off Air";
    nowTitle.textContent = "-";
    nowProgress.textContent = "-";
    nextTitle.textContent = "-";
  }

  // YouTube iframe mute/unmute control via postMessage
  function setYouTubeMute(mute) {
    if (!playerDiv.querySelector("iframe")) return;
    const command = mute ? 1 : 0;
    playerDiv.querySelector("iframe").contentWindow.postMessage(JSON.stringify({
      event: "command",
      func: mute ? "mute" : "unMute",
      args: []
    }), "*");
  }

  function playItem(item, offset = 0) {
    try {
      const url = item.url || item.src || item.link;
      const title = item.title || "Untitled";
      const isHLS = url.includes(".m3u8");
      const isYT = /youtu(?:\.be|be\.com)/.test(url);

      nowTitle.textContent = title;
      statusText.textContent = "Live Broadcasting";

      if (hlsPlayer) {
        hlsPlayer.destroy();
        hlsPlayer = null;
      }
      videoElem = null;

      if (isYT) {
        // Extract video ID for embedding
        let videoId = null;
        const ytMatch = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
        if (ytMatch) videoId = ytMatch[1];
        else {
          // fallback for youtu.be short links
          const shortMatch = url.match(/youtu\.be\/([0-9A-Za-z_-]{11})/);
          if (shortMatch) videoId = shortMatch[1];
        }
        if (!videoId) throw new Error("Invalid YouTube URL");

        playerDiv.innerHTML = `<iframe id="ytPlayer" width="100%" height="100%" 
          src="https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&mute=1&controls=1&rel=0" 
          frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;

        muted = true;
        showMuteButton();

      } else if (isHLS) {
        playerDiv.innerHTML = `<video id="m3u8Player" width="100%" height="100%" controls muted autoplay playsinline></video>`;
        videoElem = document.getElementById("m3u8Player");

        if (Hls.isSupported()) {
          hlsPlayer = new Hls();
          hlsPlayer.loadSource(url);
          hlsPlayer.attachMedia(videoElem);
          hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => {
            videoElem.play();
          });
        } else if (videoElem.canPlayType("application/vnd.apple.mpegurl")) {
          videoElem.src = url;
          videoElem.play();
        } else {
          throw new Error("Unsupported video format.");
        }

        muted = true;
        showMuteButton();

      } else {
        playerDiv.innerHTML = `<video id="genericPlayer" width="100%" height="100%" controls muted autoplay playsinline>
          <source src="${url}" />
          Your browser does not support the video tag.
        </video>`;
        videoElem = document.getElementById("genericPlayer");

        muted = true;
        showMuteButton();
      }
    } catch (err) {
      showOffAir(err.message);
    }
  }

  function toggleMute() {
    if (!muted) {
      // Unmute
      if (videoElem) {
        videoElem.muted = false;
        videoElem.volume = 1;
      }
      setYouTubeMute(false);
      muted = false;
      muteToggle.classList.add("hidden");
      muteToggle.title = "Click to Mute";
    } else {
      // Mute
      if (videoElem) {
        videoElem.muted = true;
        videoElem.volume = 0;
      }
      setYouTubeMute(true);
      muted = true;
      muteToggle.classList.remove("hidden");
      muteToggle.title = "Click to Unmute";
    }
  }

  function showMuteButton() {
    if (muted) {
      muteToggle.classList.remove("hidden");
    } else {
      muteToggle.classList.add("hidden");
    }
  }

  async function loadPlaylist() {
    try {
      const res = await fetch(playlistUrl);
      if (!res.ok) throw new Error("Failed to load playlist");
      playlist = await res.json();
      if (Array.isArray(playlist.items)) playlist = playlist.items;

      totalDuration = playlist.reduce((sum, item) => sum + parseDuration(item.duration), 0);
      createTVGuide(playlist);
      syncToRealTime();
    } catch (e) {
      showOffAir("Failed to load playlist");
      errorBox.textContent = e.message;
    }
  }

  function syncToRealTime() {
    const now = new Date();
    const secondsSinceMidnight = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
    const timeInLoop = secondsSinceMidnight % totalDuration;

    let cursor = 0;
    for (let i = 0; i < playlist.length; i++) {
      const dur = parseDuration(playlist[i].duration);
      if (cursor + dur > timeInLoop) {
        currentIndex = i;
        const progress = ((timeInLoop - cursor) / dur) * 100;
        nowProgress.textContent = `${Math.floor(progress)}%`;
        nextTitle.textContent = playlist[(i + 1) % playlist.length].title || "End";
        playItem(playlist[i], timeInLoop - cursor);
        break;
      }
      cursor += dur;
    }

    const secondsToNext = parseDuration(playlist[currentIndex].duration) - (timeInLoop - cursor);
    setTimeout(syncToRealTime, secondsToNext * 1000 + 100);
  }

  muteToggle.addEventListener("click", toggleMute);

  // Initialize
  updateClock();
  setInterval(updateClock, 1000);
  updateViewers();
  loadPlaylist();
})();
</script>
</body>
</html>
