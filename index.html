<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Global Sync YouTube Player</title>
  <style>
    html, body {
      margin: 0;
      background: black;
      overflow: hidden;
    }
    #player {
      width: 100vw;
      height: 100vh;
    }
    #loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .spinner {
      border: 8px solid #ccc;
      border-top: 8px solid gold;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #banner {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: #0055ff;
      color: white;
      padding: 6px 0;
      white-space: nowrap;
      overflow: hidden;
      z-index: 9;
    }
    #scrolling-text {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 20s linear infinite;
    }
    @keyframes scroll {
      to { transform: translateX(-100%); }
    }
    #mute-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      color: white;
      cursor: pointer;
      z-index: 20;
    }
  </style>
</head>
<body>
  <div id="player"></div>
  <div id="loading-overlay"><div class="spinner"></div></div>
  <div id="banner"><div id="scrolling-text">Loading...</div></div>
  <div id="mute-toggle">ðŸ”‡</div>

  <script>
    let player;
    let playlist = [];
    let startTimeUTC = null;
    let currentVideoIndex = 0;
    let startSeconds = 0;
    let isMuted = true;

    const urlParams = new URLSearchParams(window.location.search);
    const ch = urlParams.get("ch") || "1";
    const playlistUrl = `sync-ch=${ch}.json`;

    async function fetchPlaylist() {
      const res = await fetch(playlistUrl);
      const data = await res.json();
      playlist = data.video_list;
      startTimeUTC = new Date(data.start_time_utc).getTime();
      syncAndPlay();
      setInterval(syncAndPlay, 5000); // Sync every 5s
    }

    function updateBanner() {
      const upcoming = playlist
        .map((v, i) => (i === currentVideoIndex ? `â–¶ï¸ ${v.title}` : `â© ${v.title}`))
        .join("   â€¢   ");
      document.getElementById("scrolling-text").textContent = upcoming;
    }

    async function syncAndPlay() {
      if (!startTimeUTC || playlist.length === 0) return;

      const now = Date.now();
      const elapsedSeconds = Math.floor((now - startTimeUTC) / 1000);
      const totalDuration = playlist.reduce((sum, video) => sum + video.duration_seconds, 0);
      const loopedElapsed = elapsedSeconds % totalDuration;

      let accumulated = 0;
      for (let i = 0; i < playlist.length; i++) {
        if (loopedElapsed < accumulated + playlist[i].duration_seconds) {
          currentVideoIndex = i;
          startSeconds = loopedElapsed - accumulated;
          break;
        }
        accumulated += playlist[i].duration_seconds;
      }
      if (startSeconds < 0) startSeconds = 0;

      const video = playlist[currentVideoIndex];
      updateBanner();

      if (!player) {
        player = new YT.Player("player", {
          width: "100%",
          height: "100%",
          videoId: video.id,
          playerVars: {
            autoplay: 1,
            controls: 0,
            modestbranding: 1,
            rel: 0,
            fs: 0,
            start: startSeconds,
            mute: 1
          },
          events: {
            onReady: (event) => {
              isMuted ? event.target.mute() : event.target.unMute();
              event.target.playVideo();
            },
            onStateChange: (event) => {
              if (event.data === YT.PlayerState.PLAYING) {
                document.getElementById("loading-overlay").style.display = "none";
              }
              if (event.data === YT.PlayerState.ENDED) {
                currentVideoIndex = (currentVideoIndex + 1) % playlist.length;
                startSeconds = 0;
                const nextVideo = playlist[currentVideoIndex];
                player.loadVideoById({ videoId: nextVideo.id, startSeconds });
                updateBanner();
              }
            }
          }
        });
      } else {
        player.loadVideoById({ videoId: video.id, startSeconds });
        updateBanner();
      }
    }

    document.getElementById("mute-toggle").onclick = () => {
      isMuted = !isMuted;
      if (player && player.unMute) {
        isMuted ? player.mute() : player.unMute();
        document.getElementById("mute-toggle").textContent = isMuted ? "ðŸ”‡" : "ðŸ”Š";
      }
    };

    function onYouTubeIframeAPIReady() {
      fetchPlaylist();
    }

    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
  </script>
</body>
</html>
