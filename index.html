<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MSTV Live TV Channel</title>
<style>
  body {
    background: #111;
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  h1, p {
    text-align: center;
  }
  #playerFrame {
    width: 90vw;
    max-width: 960px;
    height: 540px;
    background: black;
    margin: 20px 0;
    border-radius: 12px;
    overflow: hidden;
  }
  #statusBar {
    width: 90vw;
    max-width: 960px;
    display: flex;
    justify-content: space-between;
    padding: 0 10px;
    font-size: 14px;
    margin-bottom: 15px;
  }
  #tvGuide {
    width: 90vw;
    max-width: 960px;
    background: rgba(255 255 255 / 0.05);
    border-radius: 8px;
    padding: 15px;
    font-size: 14px;
    max-height: 250px;
    overflow-y: auto;
  }
  .tv-guide-entry {
    padding: 5px 8px;
    border-left: 3px solid transparent;
    margin-bottom: 6px;
  }
  .tv-guide-entry.current {
    border-left-color: #4ecdc4;
    background: rgba(78, 205, 196, 0.15);
  }
  iframe, video {
    width: 100%;
    height: 100%;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

<h1>MSTV Live TV Channel</h1>
<p>Broadcasting your curated content 24/7</p>

<div id="playerFrame">
  <p style="color:#777; text-align:center; padding-top: 200px;">Loading player...</p>
</div>

<div id="statusBar">
  <div>Status: <span id="statusText">Loading...</span></div>
  <div>Time: <span id="currentTime">--:--:--</span></div>
  <div>Viewers: <span id="viewerCount">0</span></div>
</div>

<div style="width:90vw; max-width:960px; margin-bottom:10px;">
  <strong>Now Playing:</strong> <span id="currentTitle">-</span> |
  <strong>Progress:</strong> <span id="playbackProgress">-</span> |
  <strong>Next Up:</strong> <span id="nextItem">-</span>
</div>

<h3>Today's TV Guide</h3>
<div id="tvGuide"></div>

<script>
  const PLAYLIST_URL = 'https://raw.githubusercontent.com/mstvnetwork/mstv3/main/playlist.json';
  let playlist = [];
  let currentIndex = -1;

  function parseDurationToSeconds(d) {
    const p = d.split(':').map(Number);
    return p.length === 3 ? p[0]*3600 + p[1]*60 + p[2]
         : p.length === 2 ? p[0]*60 + p[1]
         : 300;
  }

  function updateClock() {
    document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
  }
  setInterval(updateClock, 1000);
  updateClock();

  function randomViewers() {
    const v = 50 + Math.floor(Math.random() * 200);
    document.getElementById('viewerCount').textContent = v;
    setTimeout(randomViewers, 30000 + Math.random() * 30000);
  }
  randomViewers();

  function isYouTubeURL(u) {
    return /youtu(be\.com|\.be)/.test(u);
  }
  function extractYouTubeID(u) {
    const m = u.match(/(?:v=|\/embed\/|youtu\.be\/)([^&?\s]+)/);
    return m ? m[1] : null;
  }

  function loadPlayer(item, elapsed) {
    const cont = document.getElementById('playerFrame');
    if (isYouTubeURL(item.url)) {
      const id = extractYouTubeID(item.url);
      cont.innerHTML = id
        ? `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id}?autoplay=1&start=${elapsed}&mute=0&controls=1&rel=0" allowfullscreen></iframe>`
        : '<div style="color:red; text-align:center; padding-top:200px;">Invalid YouTube URL</div>';
    } else if (item.url.includes('.m3u8')) {
      cont.innerHTML = `<video id="m3u8Player" controls autoplay muted width="100%" height="100%"></video>`;
      const v = document.getElementById('m3u8Player');
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(item.url);
        hls.attachMedia(v);
      } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
        v.src = item.url;
      } else {
        cont.innerHTML = '<div style="color:red; text-align:center; padding-top:200px;">HLS not supported in this browser</div>';
      }
    } else {
      cont.innerHTML = `<video src="${item.url}" controls autoplay muted width="100%" height="100%"></video>`;
    }
  }

  function updateUI(i, elapsed) {
    const cur = playlist[i], nxt = playlist[(i+1) % playlist.length];
    document.getElementById('currentTitle').textContent = cur.title;
    const progress = Math.floor(elapsed / parseDurationToSeconds(cur.duration) * 100);
    document.getElementById('playbackProgress').textContent = progress + '%';
    document.getElementById('nextItem').textContent = nxt ? nxt.title : 'End';
    document.getElementById('statusText').textContent = 'Live';
  }

  function renderTVGuide(startDayMs) {
    const gl = document.getElementById('tvGuide');
    gl.innerHTML = '';
    let cursor = startDayMs;
    playlist.forEach((it) => {
      const durS = parseDurationToSeconds(it.duration);
      const start = new Date(cursor);
      const end = new Date(cursor + durS*1000);
      const now = Date.now();
      const isCurrent = now >= cursor && now < cursor + durS*1000;
      const div = document.createElement('div');
      div.className = 'tv-guide-entry' + (isCurrent ? ' current' : '');
      div.textContent = `${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} â€“ ${end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} :: ${it.title}`;
      gl.appendChild(div);
      cursor += durS * 1000;
    });
  }

  async function initLiveTV() {
    console.log('Fetching playlist from', PLAYLIST_URL);
    try {
      const res = await fetch(PLAYLIST_URL);
      if (!res.ok) throw new Error('HTTP status ' + res.status);
      playlist = await res.json();
      console.log('Playlist loaded:', playlist);
    } catch (e) {
      console.error('Error loading playlist:', e);
      document.getElementById('statusText').textContent = 'Failed to load playlist';
      return;
    }
    if (!Array.isArray(playlist) || playlist.length === 0) {
      console.error('Playlist invalid or empty');
      document.getElementById('statusText').textContent = 'Invalid playlist';
      return;
    }

    // Calculate which item should be playing now
    const now = Date.now();
    const startOfDay = new Date().setHours(0,0,0,0);
    let elapsedToday = Math.floor((now - startOfDay) / 1000);

    let acc = 0;
    for (let i = 0; i < playlist.length; i++) {
      const durS = parseDurationToSeconds(playlist[i].duration);
      if (acc + durS > elapsedToday) {
        currentIndex = i;
        const itemElapsed = elapsedToday - acc;
        loadPlayer(playlist[i], itemElapsed);
        updateUI(i, itemElapsed);
        break;
      }
      acc += durS;
    }

    renderTVGuide(startOfDay);

    // Every 15 seconds check if we need to switch to next item
    setInterval(() => {
      const now = Date.now();
      const elapsedToday = Math.floor((now - startOfDay) / 1000);
      let acc = 0;
      for (let i = 0; i < playlist.length; i++) {
        const durS = parseDurationToSeconds(playlist[i].duration);
        if (acc + durS > elapsedToday && i !== currentIndex) {
          currentIndex = i;
          const itemElapsed = elapsedToday - acc;
          loadPlayer(playlist[i], itemElapsed);
          updateUI(i, itemElapsed);
          renderTVGuide(startOfDay);
          break;
        }
        acc += durS;
      }
    }, 15000);
  }

  document.addEventListener('DOMContentLoaded', initLiveTV);
</script>

</body>
</html>
